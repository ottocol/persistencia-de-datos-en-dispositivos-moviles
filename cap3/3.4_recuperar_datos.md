### Recuperar datos (0,4 puntos)

Vamos a añadir una pantalla donde se puedan consultar las notas que tenemos almacenadas. Las listaremos en una *table view* y por el momento se verán todas, no se podrá filtrar (añadiremos esa posibilidad cuando veamos la sintaxis de las "consultas" o *fetch requests*).

#### La interfaz de usuario

Sigue estos pasos:

- **Crear el Tab Bar Controller**: teniendo seleccionada la única pantalla de la aplicación, ve al menú y selecciona `Editor > Embed In > Tab Bar Controller`. Se creará el *tab bar controller*, por el momento con una única "solapa" que será la pantalla de creación de notas
- En la pantalla de creación de notas, pulsa sobre el item de la barra inferior para editarlo, y ponle como `Title` por ejemplo `Nueva`, para que se vea que es la pantalla de creación de notas
- Crear la pantalla para listar notas: Arrastrar al *storyboard* un `Table view controller`. Recuerda que es una especie de tabla a “pantalla completa”
	- Cambiar el aspecto del prototipo: pulsa sobre la celda prototipo de la tabla, y en las propiedades cambia el `Style` a otro que no sea `Custom`  
	- Poner un *reuse identifier*: pon algún `Identifier` por ejemplo `Cell` (recuerda que este identificador se emplea luego en el código para solicitar al sistema instancias reutilizables de celdas)
- Vincular la nueva pantalla al *tab bar controller*: hacer `Ctrl+Arrastrar` desde la pantalla del *tab bar* hasta la de listado de notas. En el menú contextual elegir como tipo del *segue* el último, `View Controllers`.
- Finalmente, tenemos que crear un controlador para la nueva pantalla de listado: crear una clase `ListaNotasController` que herede de `UITableViewController`
- Hacer que la nueva clase sea el controlador de la pantalla de listado de notas: tienes que seleccionar la pantalla de listado de notas (pulsa sobre el primero de los iconos de la barra superior, el de fondo amarillo) y en el Identity Inspector (![](Captura%20de%20pantalla%202015-01-26%20a%20las%2011.31.48.png), tercero de los iconos del área de la derecha), como “Custom Class” poner `ListaNotasController`

#### El código de la pantalla de listado

En la tabla vamos a dibujar un `Array` de notas. Lo primero será definir la propiedad correspondiente en el `ListaNotasController`

	@property NSArray *notas;

Tendrás también que modificar los métodos de gestión de la tabla. En la plantilla ya están definidos, pero aparecen entre comentarios, descoméntalos y modifícalos como sigue:

- `numberOfSectionsInTableView`, para que devuelva 1, ya que solo hay una sección en la tabla
- `tableView:numberOfRowsInSection:`, para que devuelva el tamaño del array `notas`.
- `tableView:cellForRowAtIndexPath:`, para que devuelva la celda en la fila especificada.

Este último quedaría:

	UITableViewCell *cell = [tableView
	          dequeueReusableCellWithIdentifier:@"Cell" 
	          forIndexPath:indexPath];   
	// Configure the cell...
	cell.textLabel.text = [self.notas[indexPath.row] 
	                        valueForKey:@"texto"];


Solo nos queda rellenar el array de notas. Para recuperar datos de Core Data se usa un *fetch request*. Podemos ejecutar uno sin especificar condiciones para recuperar todas las instancias de una entidad. En el `viewDidLoad` de `ListaNotasController` puedes introducir el siguiente código


	AppDelegate *miDelegate = [[UIApplication sharedApplication] delegate];
	NSManagedObjectContext *miContexto = [miDelegate managedObjectContext];
	NSFetchRequest *fetchRequest = [NSFetchRequest 
	          fetchRequestWithEntityName:@"Nota"];
	NSError *error;
	self.notas = [miContexto executeFetchRequest:fetchRequest
	                            error:&error];
	//refrescar la tabla, si no no aparecerán los datos
	[self.tableView reloadData];

Fíjate en que *las nuevas notas que creemos no van a aparecer en la lista*, salvo que pares la aplicación y la vuelvas a arrancar, ya que el `viewDidLoad` solo se ejecuta una vez. Habría dos soluciones posibles: una sería colocar el código en el método `viewWillAppear`, que se ejecuta justo antes de mostrar un controlador (habrá que añadirlo manualmente, ya que la plantilla de Xcode no lo sobreescribe por defecto). Otra sería usar un *fetched results controller* para mostrar los datos, que es lo que se usa normalmente cuando se quieren mostrar datos de Core Data en una tabla. Este *controller* es mucho más flexible y potente y gestiona automáticamente cosas como la actualización automática del listado si se actualizan los objetos persistentes. Veremos los *fetched results controllers* en sesiones posteriores.

